<div class="empreendimento-detalhes" *ngIf="empreendimento && !carregando">
  <app-breadcrumb [items]="breadcrumbItems"></app-breadcrumb>

  <div class="detalhes-header">
    <button pButton type="button" icon="pi pi-arrow-left" 
            class="p-button-text p-button-secondary btn-voltar"
            (click)="voltar()" label="Voltar"></button>

    <app-page-header 
      [title]="empreendimento.nome"
      [subtitle]="empreendimento.descricao">
    </app-page-header>
  </div>

  <!-- Informações do Empreendimento -->
  <div class="info-container">
    <p-card>
      <ng-template pTemplate="header">
        <div class="card-header-custom">
          <i class="pi pi-building"></i>
          <h3>Informações do Empreendimento</h3>
        </div>
      </ng-template>

      <div class="info-grid">
        <div class="info-item">
          <label><i class="pi pi-tag"></i> Status</label>
          <p-chip 
            [label]="empreendimento.status"
            [style]="{ 
              'background-color': getStatusEmpColor(empreendimento.status).bg, 
              'color': getStatusEmpColor(empreendimento.status).color 
            }">
            <i [class]="getStatusEmpColor(empreendimento.status).icon" class="mr-2"></i>
          </p-chip>
        </div>

        <div class="info-item">
          <label><i class="pi pi-calendar"></i> Previsão de Entrega</label>
          <span class="value">{{ empreendimento.dataPrevistaEntrega }}</span>
        </div>

        <div class="info-item">
          <label><i class="pi pi-building-columns"></i> Construtora</label>
          <span class="value">{{ empreendimento.construtora }}</span>
        </div>

        <div class="info-item">
          <label><i class="pi pi-map-marker"></i> Localização</label>
          <span class="value">{{ empreendimento.cidade }} - {{ empreendimento.estado }}</span>
        </div>
      </div>

      <p-divider></p-divider>

      <!-- Estatísticas -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon total">
            <i class="pi pi-home"></i>
          </div>
          <div class="stat-content">
            <span class="stat-label">Total de Unidades</span>
            <span class="stat-value">{{ empreendimento.totalUnidades }}</span>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon disponiveis">
            <i class="pi pi-check-circle"></i>
          </div>
          <div class="stat-content">
            <span class="stat-label">Disponíveis</span>
            <span class="stat-value">{{ empreendimento.unidadesDisponiveis }}</span>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon preco-min">
            <i class="pi pi-dollar"></i>
          </div>
          <div class="stat-content">
            <span class="stat-label">Preço Mínimo</span>
            <span class="stat-value">{{ formatarValor(empreendimento.valorMinimo) }}</span>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon preco-max">
            <i class="pi pi-money-bill"></i>
          </div>
          <div class="stat-content">
            <span class="stat-label">Preço Máximo</span>
            <span class="stat-value">{{ formatarValor(empreendimento.valorMaximo) }}</span>
          </div>
        </div>
      </div>
    </p-card>
  </div>

  <!-- Visualização de Unidades -->
  <div class="unidades-container">
    <p-card>
      <ng-template pTemplate="header">
        <div class="unidades-header">
          <div class="header-left">
            <i class="pi pi-th-large"></i>
            <h3>Unidades Disponíveis ({{ unidadesFiltradas.length }})</h3>
          </div>
          
          <div class="header-right">
            <p-selectButton 
              [options]="visualizacaoOptions" 
              [(ngModel)]="visualizacao"
              optionLabel="label" 
              optionValue="value">
              <ng-template let-item>
                <i [class]="item.icon"></i>
                <span class="ml-2">{{ item.label }}</span>
              </ng-template>
            </p-selectButton>
          </div>
        </div>

        <!-- Busca por Unidade -->
        <div class="busca-unidade-container">
          <div class="busca-unidade">
            <label><i class="pi pi-search"></i> Buscar Unidade</label>
            <p-autoComplete
              [(ngModel)]="unidadeSelecionada"
              [suggestions]="unidadesFiltradasAutocomplete"
              (completeMethod)="buscarUnidades($event)"
              (onSelect)="aoSelecionarUnidade($event)"
              (onClear)="limparSelecaoUnidade()"
              field="unidade"
              [dropdown]="true"
              [forceSelection]="true"
              [showClear]="true"
              placeholder="Digite o código, tipo ou bloco da unidade"
              [minLength]="1"
              emptyMessage="Nenhuma unidade encontrada">
              <ng-template let-unidade pTemplate="item">
                <div class="autocomplete-item">
                  <div class="item-header">
                    <span class="codigo">{{ unidade.unidade }}</span>
                    <span class="sigla">{{ unidade.sigla }}</span>
                  </div>
                  <div class="item-body">
                    <span class="tipologia">{{ unidade.tipologia }}</span>
                    <span class="bloco">Bloco {{ unidade.bloco }}</span>
                  </div>
                  <div class="item-footer">
                    <span class="status">{{ unidade.statusUnidade }}</span>
                    <span class="preco">{{ formatarValor(unidade.preco) }}</span>
                  </div>
                </div>
              </ng-template>
            </p-autoComplete>
          </div>
        </div>

        <!-- Filtros -->
        <div class="filtros-container">
          <div class="filtro-item">
            <label>Status</label>
            <p-autoComplete
              [(ngModel)]="statusSelecionado"
              [suggestions]="statusFiltrados"
              (completeMethod)="buscarStatus($event)"
              field="label"
              [dropdown]="true"
              [forceSelection]="false"
              [showClear]="true"
              placeholder="Selecione o status"
              (onSelect)="aplicarFiltros()"
              (onClear)="aplicarFiltros()">
            </p-autoComplete>
          </div>

          <div class="filtro-item">
            <label>Tipo</label>
            <p-autoComplete
              [(ngModel)]="tipoSelecionado"
              [suggestions]="tiposFiltrados"
              (completeMethod)="buscarTipos($event)"
              field="label"
              [dropdown]="true"
              [forceSelection]="false"
              [showClear]="true"
              placeholder="Selecione o tipo"
              (onSelect)="aplicarFiltros()"
              (onClear)="aplicarFiltros()">
            </p-autoComplete>
          </div>

          <button pButton type="button" 
                  icon="pi pi-filter-slash" 
                  label="Limpar Filtros"
                  class="p-button-outlined"
                  (click)="limparFiltros()"
                  [disabled]="!statusSelecionado && !tipoSelecionado">
          </button>
        </div>
      </ng-template>

      <!-- Visualização em Cubo 3D -->
      <div class="cubo-view" *ngIf="visualizacao === 'planta'">
        <!-- Controles de Rotação -->
        <div class="controles-cubo">
          <div class="controles-horizontais">
            <button pButton type="button" 
                    icon="pi pi-chevron-left" 
                    class="p-button-rounded p-button-outlined"
                    (click)="rotacionarCubo('anterior')"
                    [disabled]="animandoCubo"
                    pTooltip="Bloco Anterior"
                    tooltipPosition="top"></button>
            
            <div class="info-bloco-atual">
              <i class="pi pi-building"></i>
              <span>Bloco {{ getBlocos()[blocoAtual] }}</span>
            </div>
            
            <button pButton type="button" 
                    icon="pi pi-chevron-right" 
                    class="p-button-rounded p-button-outlined"
                    (click)="rotacionarCubo('proximo')"
                    [disabled]="animandoCubo"
                    pTooltip="Próximo Bloco"
                    tooltipPosition="top"></button>
          </div>
        </div>

        <!-- Container do Cubo 3D -->
        <div class="scene-container">
          <div class="cube" [style.transform]="'rotateY(' + rotacaoY + 'deg) rotateX(' + rotacaoX + 'deg)'">
            <!-- Face para cada bloco -->
            <div class="cube-face face-front" 
                 *ngIf="getBlocos()[0]"
                 [attr.data-bloco]="getBlocos()[0]">
              <div class="face-content">
                <div class="andares-container">
                  <div class="andar-row" *ngFor="let andar of getAndares(getBlocos()[0])">
                    <div class="andar-label">{{ andar }}º</div>
                    <div class="unidades-andar">
                      <div *ngFor="let unidade of getUnidadesDoAndar(getBlocos()[0], andar)"
                           class="unidade-mini"
                           [pTooltip]="unidade.tipologia + ' - ' + formatarValor(unidade.preco)"
                           (click)="selecionarUnidade(unidade)">
                        {{ unidade.unidade }}
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="cube-face face-right" 
                 *ngIf="getBlocos()[1]"
                 [attr.data-bloco]="getBlocos()[1]">
              <div class="face-content">
                <div class="andares-container">
                  <div class="andar-row" *ngFor="let andar of getAndares(getBlocos()[1])">
                    <div class="andar-label">{{ andar }}º</div>
                    <div class="unidades-andar">
                      <div *ngFor="let unidade of getUnidadesDoAndar(getBlocos()[1], andar)"
                           class="unidade-mini"
                           [pTooltip]="unidade.tipologia + ' - ' + formatarValor(unidade.preco)"
                           (click)="selecionarUnidade(unidade)">
                        {{ unidade.unidade }}
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="cube-face face-back" 
                 *ngIf="getBlocos()[2]"
                 [attr.data-bloco]="getBlocos()[2]">
              <div class="face-content">
                <div class="andares-container">
                  <div class="andar-row" *ngFor="let andar of getAndares(getBlocos()[2])">
                    <div class="andar-label">{{ andar }}º</div>
                    <div class="unidades-andar">
                      <div *ngFor="let unidade of getUnidadesDoAndar(getBlocos()[2], andar)"
                           class="unidade-mini"
                           [pTooltip]="unidade.tipologia + ' - ' + formatarValor(unidade.preco)"
                           (click)="selecionarUnidade(unidade)">
                        {{ unidade.unidade }}
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="cube-face face-left" 
                 *ngIf="getBlocos()[3]"
                 [attr.data-bloco]="getBlocos()[3]">
              <div class="face-content">
                <div class="andares-container">
                  <div class="andar-row" *ngFor="let andar of getAndares(getBlocos()[3])">
                    <div class="andar-label">{{ andar }}º</div>
                    <div class="unidades-andar">
                      <div *ngFor="let unidade of getUnidadesDoAndar(getBlocos()[3], andar)"
                           class="unidade-mini"
                           [pTooltip]="unidade.tipologia + ' - ' + formatarValor(unidade.preco)"
                           (click)="selecionarUnidade(unidade)">
                        {{ unidade.unidade }}
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="cube-face face-top" 
                 *ngIf="getBlocos()[4]">
              <div class="face-content">
                <div class="andares-container">
                  <div class="andar-row" *ngFor="let andar of getAndares(getBlocos()[4])">
                    <div class="andar-label">{{ andar }}º</div>
                    <div class="unidades-andar">
                      <div *ngFor="let unidade of getUnidadesDoAndar(getBlocos()[4], andar)"
                           class="unidade-mini"
                           [pTooltip]="unidade.tipologia + ' - ' + formatarValor(unidade.preco)"
                           (click)="selecionarUnidade(unidade)">
                        {{ unidade.unidade }}
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="cube-face face-bottom" 
                 *ngIf="getBlocos()[5]">
              <div class="face-content">
                <div class="andares-container">
                  <div class="andar-row" *ngFor="let andar of getAndares(getBlocos()[5])">
                    <div class="andar-label">{{ andar }}º</div>
                    <div class="unidades-andar">
                      <div *ngFor="let unidade of getUnidadesDoAndar(getBlocos()[5], andar)"
                           class="unidade-mini"
                           [pTooltip]="unidade.tipologia + ' - ' + formatarValor(unidade.preco)"
                           (click)="selecionarUnidade(unidade)">
                        {{ unidade.unidade }}
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Visualização em Grid -->
      <div class="grid-view" *ngIf="visualizacao === 'grid'">
        <div class="unidade-card-grid" 
             *ngFor="let unidade of unidadesFiltradas"
             (click)="selecionarUnidade(unidade)">
          <div class="card-header" style="background-color: #e0e7ff">
            <span class="unidade-codigo">{{ unidade.unidade }}</span>
            <p-tag 
              [value]="unidade.statusUnidade"
              severity="info">
            </p-tag>
          </div>
          
          <div class="card-body">
            <div class="unidade-tipo-icon">
              <i class="pi pi-home"></i>
              <span>{{ unidade.tipologia }}</span>
            </div>
            
            <div class="unidade-specs">
              <div class="spec">
                <i class="pi pi-tag"></i>
                <span>{{ unidade.sigla }}</span>
              </div>
              <div class="spec">
                <i class="pi pi-building"></i>
                <span>Bloco {{ unidade.bloco }}</span>
              </div>
            </div>
            
            <div class="unidade-preco">
              {{ formatarValor(unidade.preco) }}
            </div>
          </div>
        </div>
      </div>

      <!-- Visualização em Cards -->
      <div class="cards-view" *ngIf="visualizacao === 'cards'">
        <p-card *ngFor="let unidade of unidadesFiltradas" class="unidade-card-detalhada">
          <ng-template pTemplate="header">
            <div class="card-header-detalhada">
              <div class="header-left">
                <h4>{{ unidade.tipologia }}</h4>
                <span class="codigo">Código: {{ unidade.unidade }}</span>
              </div>
              <p-tag 
                [value]="unidade.statusUnidade"
                severity="info">
              </p-tag>
            </div>
          </ng-template>

          <div class="card-content-detalhada">
            <div class="info-row">
              <div class="info-col">
                <i class="pi pi-home"></i>
                <div>
                  <label>Tipo</label>
                  <span>{{ unidade.tipo }}</span>
                </div>
              </div>

              <div class="info-col">
                <i class="pi pi-building"></i>
                <div>
                  <label>Bloco</label>
                  <span>{{ unidade.bloco }}</span>
                </div>
              </div>

              <div class="info-col">
                <i class="pi pi-tag"></i>
                <div>
                  <label>Sigla</label>
                  <span>{{ unidade.sigla }}</span>
                </div>
              </div>

              <div class="info-col">
                <i class="pi pi-percentage"></i>
                <div>
                  <label>Fração Ideal</label>
                  <span>{{ formatarFracaoIdeal(unidade.fracaoIdeal) }}</span>
                </div>
              </div>
            </div>

            <p-divider></p-divider>

            <div class="preco-row">
              <div class="preco-info">
                <label>Valor da Unidade</label>
                <span class="preco">{{ formatarValor(unidade.preco) }}</span>
              </div>
              
              <button pButton type="button" 
                      label="Ver Detalhes" 
                      icon="pi pi-eye"
                      class="p-button-rounded"
                      (click)="selecionarUnidade(unidade)">
              </button>
            </div>
          </div>
        </p-card>
      </div>

      <!-- Estado Vazio -->
      <div class="empty-state" *ngIf="unidadesFiltradas.length === 0 && !carregando">
        <i class="pi pi-inbox"></i>
        <p>Nenhuma unidade encontrada com os filtros selecionados</p>
        <button pButton type="button" 
                label="Limpar Filtros" 
                icon="pi pi-filter-slash"
                class="p-button-outlined"
                (click)="limparFiltros()">
        </button>
      </div>
    </p-card>
  </div>
</div>

<!-- Loading -->
<div class="loading-container" *ngIf="carregando">
  <app-loading-spinner message="Carregando dados do empreendimento..."></app-loading-spinner>
</div>

<p-toast position="top-right"></p-toast>
