<div class="form-container">
  <!-- Toast para mensagens -->
  <p-toast position="top-right"></p-toast>

  <!-- Breadcrumb -->
  <app-breadcrumb [items]="breadcrumbItems"></app-breadcrumb>

  <!-- Page Header -->
  <app-page-header
    title="Detalhes da Mensagem"
    subtitle="Visualize e responda a mensagem de contato"
    icon="pi pi-envelope">
    <div actions>
      <app-custom-button
        label="Voltar"
        icon="pi pi-arrow-left"
        severity="secondary"
        [outlined]="true"
        (onClick)="voltarParaLista()">
      </app-custom-button>
    </div>
  </app-page-header>

  <!-- Loading -->
  <app-loading-spinner *ngIf="carregando || marcandoLida" [overlay]="true" 
    [message]="carregando ? 'Carregando...' : 'Marcando como lida...'">
  </app-loading-spinner>

  <div *ngIf="contato && !carregando">
    <!-- Informações da Mensagem -->
    <p-card header="Informações da Mensagem" styleClass="mb-3">
      <div class="grid mt-2">
        <!-- Status -->
        <div class="col-12 md:col-6 lg:col-3">
          <div class="info-field">
            <label class="mb-2">Status</label>
            <div class="mt-2">
              <p-tag 
                [value]="getStatusLabel(contato.status!)" 
                [severity]="getStatusSeverity(contato.status!)">
              </p-tag>
            </div>
          </div>
        </div>

        <!-- Data de Criação -->
        <div class="col-12 md:col-6 lg:col-3">
          <div class="info-field">
            <label class="mb-2">Data de Envio</label>
            <div class="value mt-2">{{ formatarData(contato.dataCriacao) }}</div>
          </div>
        </div>

        <!-- Data de Leitura -->
        <div class="col-12 md:col-6 lg:col-3" *ngIf="contato.dataLeitura">
          <div class="info-field">
            <label class="mb-2">Data de Leitura</label>
            <div class="value mt-2">{{ formatarData(contato.dataLeitura) }}</div>
          </div>
        </div>

        <!-- Data de Resposta -->
        <div class="col-12 md:col-6 lg:col-3" *ngIf="contato.dataResposta">
          <div class="info-field">
            <label class="mb-2">Data de Resposta</label>
            <div class="value mt-2">{{ formatarData(contato.dataResposta) }}</div>
          </div>
        </div>
      </div>

      <p-divider class="my-4"></p-divider>

      <div class="grid mt-2">
        <!-- Nome -->
        <div class="col-12 md:col-6">
          <div class="info-field">
            <label class="mb-2">Nome</label>
            <div class="value mt-2">{{ contato.nome }}</div>
          </div>
        </div>

        <!-- Email -->
        <div class="col-12 md:col-6">
          <div class="info-field">
            <label class="mb-2">E-mail</label>
            <div class="value mt-2">
              <a [href]="'mailto:' + contato.email" class="email-link">
                <i class="pi pi-envelope mr-2"></i>{{ contato.email }}
              </a>
            </div>
          </div>
        </div>

        <!-- Telefone -->
        <div class="col-12 md:col-6" *ngIf="contato.telefone">
          <div class="info-field">
            <label class="mb-2">Telefone</label>
            <div class="value mt-2">
              <a [href]="'tel:' + contato.telefone" class="phone-link">
                <i class="pi pi-phone mr-2"></i>{{ contato.telefone }}
              </a>
            </div>
          </div>
        </div>

        <!-- Assunto -->
        <div class="col-12">
          <div class="info-field mb-4">
            <label class="mb-2">Assunto</label>
            <div class="value font-semibold mt-2">{{ contato.assunto }}</div>
          </div>
        </div>

        <!-- Mensagem -->
        <div class="col-12">
          <div class="info-field">
            <label class="mb-3">Mensagem</label>
            <div class="message-content mt-3">
              {{ contato.mensagem }}
            </div>
          </div>
        </div>
      </div>
    </p-card>

    <!-- Resposta Existente -->
    <p-card header="Resposta Enviada" styleClass="mt-4" *ngIf="contato.resposta">
      <div class="grid mt-2">
        <!-- Usuário que Respondeu -->
        <div class="col-12 md:col-6" *ngIf="contato.usuarioResposta">
          <div class="info-field">
            <label class="mb-2">Respondido por</label>
            <div class="value mt-2">{{ contato.usuarioResposta }}</div>
          </div>
        </div>

        <!-- Resposta -->
        <div class="col-12">
          <div class="info-field">
            <label class="mb-3">Resposta</label>
            <div class="message-content response-content mt-3">
              {{ contato.resposta }}
            </div>
          </div>
        </div>
      </div>
    </p-card>

    <!-- Formulário de Resposta -->
    <p-card header="Responder Mensagem" styleClass="mt-4" 
      *ngIf="!contato.resposta && podeAlterar">
      
      <div *ngIf="!modoResposta" class="text-center p-5">
        <p class="mb-4 text-lg">Clique no botão abaixo para responder esta mensagem.</p>
        <app-custom-button
          label="Responder"
          icon="pi pi-reply"
          severity="success"
          (onClick)="ativarModoResposta()">
        </app-custom-button>
      </div>

      <div *ngIf="modoResposta">
        <!-- Loading Salvamento -->
        <app-loading-spinner *ngIf="salvando" [overlay]="true" message="Enviando resposta..."></app-loading-spinner>

        <div class="p-fluid mt-3">
          <div class="p-field mb-4">
            <app-input-textarea
              id="resposta"
              label="Sua Resposta"
              [(ngModel)]="resposta"
              [required]="true"
              [rows]="8"
              [showValidation]="tentouSalvar"
              placeholder="Digite sua resposta...">
            </app-input-textarea>
            <small class="help-text mt-2 block">
              <i class="pi pi-info-circle mr-1"></i> A resposta será enviada automaticamente por email para {{ contato.email }}
            </small>
          </div>

          <div class="form-actions mt-4">
            <app-custom-button
              label="Cancelar"
              icon="pi pi-times"
              severity="secondary"
              [outlined]="true"
              (onClick)="cancelarResposta()"
              [disabled]="salvando">
            </app-custom-button>
            <app-custom-button
              label="Enviar Resposta"
              icon="pi pi-send"
              severity="success"
              (onClick)="enviarResposta()"
              [loading]="salvando">
            </app-custom-button>
          </div>
        </div>
      </div>
    </p-card>

    <!-- Mensagem se não pode responder -->
    <p-card styleClass="mt-4" *ngIf="!contato.resposta && !podeAlterar">
      <div class="text-center p-5 text-muted">
        <i class="pi pi-lock" style="font-size: 2.5rem;" class="mb-3"></i>
        <p class="mt-3 text-lg">Você não tem permissão para responder mensagens.</p>
      </div>
    </p-card>
  </div>
</div>
