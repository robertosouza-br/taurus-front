<div class="form-container">
  <!-- Breadcrumb -->
  <app-breadcrumb [items]="breadcrumbItems"></app-breadcrumb>

  <!-- Page Header -->
  <app-page-header
    title="Novo Usuário"
    subtitle="Cadastre um novo usuário no sistema"
    icon="pi pi-user-plus">
  </app-page-header>

  <div class="loading-container" *ngIf="carregando">
    <app-loading-spinner message="Carregando informações..."></app-loading-spinner>
  </div>

  <div class="usuario-form" *ngIf="!carregando">
    <!-- Dados Básicos -->
    <p-card header="Dados do Usuário">
      <div class="p-fluid">
        <br>
        <div class="p-field">
          <app-input-text
            id="nome"
            label="Nome Completo"
            [(ngModel)]="nome"
            [required]="true"
            [showValidation]="tentouSalvar">
          </app-input-text>
        </div>

        <div class="p-field">
          <app-input-text
            id="email"
            label="E-mail"
            [(ngModel)]="email"
            [required]="true"
            [showValidation]="tentouSalvar"
            type="email">
          </app-input-text>
        </div>

        <div class="p-field">
          <app-input-cpf
            id="cpf"
            label="CPF"
            [(ngModel)]="cpf"
            [required]="true"
            [showValidation]="tentouSalvar">
          </app-input-cpf>
        </div>

        <div class="p-field">
          <app-input-telefone
            id="telefone"
            label="Telefone"
            [(ngModel)]="telefone"
            [required]="false"
            [showValidation]="tentouSalvar"
            placeholder="(00) 00000-0000">
          </app-input-telefone>
        </div>

        <div class="p-field">
          <app-input-text
            id="apelido"
            label="Apelido"
            [(ngModel)]="apelido"
            [required]="false"
            [showValidation]="tentouSalvar"
            placeholder="Informe um apelido para o usuário">
          </app-input-text>
        </div>

        <div class="p-field">
          <app-input-date
            id="dataExpiracao"
            label="Data de Expiração"
            [(ngModel)]="dataExpiracao"
            [required]="false"
            [showValidation]="tentouSalvar">
          </app-input-date>
          <div class="field-helper">
            <i class="pi pi-info-circle"></i>
            <span>Deixe vazio para acesso ilimitado</span>
          </div>
        </div>

        <app-autocomplete
          id="perfil"
          label="Perfil"
          [(ngModel)]="perfilSelecionado"
          [suggestions]="perfisFiltrados"
          (completeMethod)="filtrarPerfis($event)"
          (onDropdownClick)="mostrarTodosPerfis()"
          field="nome"
          [required]="true"
          [showValidation]="tentouSalvar"
          [disabled]="!usuarioLogadoEhAdministrador"
          emptyMessage="Nenhum resultado encontrado"
          placeholder="Digite para buscar um perfil"
          [itemTemplate]="perfilTemplate">
        </app-autocomplete>
        <div class="field-helper" *ngIf="!usuarioLogadoEhAdministrador">
          <i class="pi pi-info-circle"></i>
          <span>O perfil será automaticamente definido como CORRETOR</span>
        </div>

        <ng-template #perfilTemplate let-perfil>
          <div>
            <div><strong>{{perfil.nome}}</strong></div>
            <small>{{perfil.descricao}}</small>
          </div>
        </ng-template>

        <div class="p-field-checkbox">
          <p-checkbox
            [(ngModel)]="ativo"
            [binary]="true"
            inputId="ativo"
            label="Usuário Ativo">
          </p-checkbox>
        </div>

        <div class="senha-info-box">
          <i class="pi pi-lock"></i>
          <div class="senha-info-text">
            <strong>Senha gerada automaticamente</strong>
            <p>A senha será enviada para o e-mail de cadastro</p>
          </div>
        </div>
        <br>
      </div>
    </p-card>

    <!-- Ações -->
    <div class="form-actions">
      <app-custom-button
        label="Cancelar"
        icon="pi pi-times"
        severity="warning"
        (onClick)="cancelar()"
        [disabled]="salvando">
      </app-custom-button>
      <app-custom-button
        label="Limpar"
        icon="pi pi-refresh"
        severity="info"
        [outlined]="true"
        (onClick)="limparTela()"
        [disabled]="salvando">
      </app-custom-button>
      <app-custom-button
        label="Criar Usuário"
        icon="pi pi-save"
        severity="success"
        (onClick)="salvarUsuario()"
        [loading]="salvando">
      </app-custom-button>
    </div>
  </div>
</div>

<!-- Modal para exibir senha gerada -->
<p-dialog
  header="Usuário Criado com Sucesso"
  [(visible)]="mostrarModalSenha"
  [modal]="true"
  [closable]="false"
  [style]="{width: '450px'}">
  <div class="senha-gerada-container">
    <p-message severity="success" text="O usuário foi criado com sucesso!"></p-message>
    <br>
    <p><strong>Senha gerada:</strong></p>
    <div class="senha-display">
      <code>{{ senhaGerada }}</code>
      <app-custom-button
        icon="pi pi-copy"
        severity="info"
        [text]="true"
        tooltip="Copiar senha"
        (onClick)="copiarSenha()">
      </app-custom-button>
    </div>
    <br>
    <p-message severity="warn" text="Importante: Anote esta senha. Por segurança, ela não será exibida novamente."></p-message>
  </div>
  <ng-template pTemplate="footer">
    <app-custom-button
      label="Fechar"
      icon="pi pi-check"
      severity="success"
      (onClick)="fecharModalSenha()">
    </app-custom-button>
  </ng-template>
</p-dialog>
