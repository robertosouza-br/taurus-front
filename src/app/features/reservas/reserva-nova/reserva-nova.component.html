<div class="reserva-nova-page">
  <!-- Countdown Timer -->
  <app-countdown-timer
    [duracao]="duracaoTimer"
    [autoStart]="unidadeBloqueada"
    mensagem="Tempo para finalizar a reserva"
    position="top-right"
    (onTimeout)="handleTimeout()"
    (onTick)="onTimerTick($event)">
  </app-countdown-timer>

  <!-- Breadcrumb -->
  <app-breadcrumb [items]="breadcrumbItems"></app-breadcrumb>

  <!-- Header -->
  <app-page-header
    title="Nova Reserva"
    [subtitle]="bloco && unidade ? 'Bloco ' + bloco + ' · Unidade ' + unidade : 'Preencha os dados abaixo'"
    icon="pi pi-bookmark">
    <div header-actions class="flex gap-2 flex-wrap">
      <app-custom-button
        label="Voltar"
        icon="pi pi-arrow-left"
        severity="secondary"
        [outlined]="true"
        (onClick)="voltar()">
      </app-custom-button>
      <app-custom-button
        label="Salvar Reserva"
        icon="pi pi-save"
        severity="success"
        [loading]="salvando"
        [disabled]="verificandoReserva"
        (onClick)="salvar()">
      </app-custom-button>
    </div>
  </app-page-header>

  <!-- Alerta: verificando reserva existente -->
  <div *ngIf="verificandoReserva" class="verificando-banner">
    <p-progressSpinner [style]="{'width':'20px','height':'20px'}" strokeWidth="4"></p-progressSpinner>
    <span>Verificando reservas existentes para esta unidade...</span>
  </div>

  <!-- Formulário -->
  <div class="reserva-form-container">

    <!-- ─── BANNER DA UNIDADE ──────────────────────────────────────────── -->
    <div class="unidade-banner" *ngIf="codEmpreendimento">
      <div class="unidade-banner-grid">
        <div class="unidade-info-item">
          <span class="info-label">Empreendimento</span>
          <span class="info-valor">{{ nomeEmpreendimento || ('Cód. ' + codEmpreendimento) }}</span>
        </div>
        <div class="unidade-info-item">
          <span class="info-label">Bloco</span>
          <span class="info-valor destaque">{{ bloco }}</span>
        </div>
        <div class="unidade-info-item">
          <span class="info-label">Unidade</span>
          <span class="info-valor destaque">{{ unidade }}</span>
        </div>
        <div class="unidade-info-item" *ngIf="tipoUnidade">
          <span class="info-label">Tipo</span>
          <span class="info-valor">{{ tipoUnidade }}</span>
        </div>
        <div class="unidade-info-item" *ngIf="tipologia">
          <span class="info-label">Tipologia</span>
          <span class="info-valor">{{ tipologia }}</span>
        </div>
        <div class="unidade-info-item" *ngIf="precoUnidade">
          <span class="info-label">Preço</span>
          <span class="info-valor preco">{{ formatarPreco(precoUnidade) }}</span>
        </div>
      </div>
    </div>

    <!-- ─── CARD: STATUS DA RESERVA ───────────────────────────────────── -->
    <p-card class="reserva-card">
      <ng-template pTemplate="header">
        <div class="card-gradient-header">
          <i class="pi pi-flag"></i>
          <span>Status da Reserva</span>
        </div>
      </ng-template>

      <div class="grid">
        <div class="col-12 md:col-8">
          <app-autocomplete
            id="statusReserva"
            label="Status da Reserva"
            [(ngModel)]="statusSelecionado"
            [required]="false"
            [suggestions]="statusSugestoes"
            field="label"
            placeholder="Selecione o status"
            (completeMethod)="filtrarStatus($event)"
            (onDropdownClick)="onDropdownClickStatus()">
          </app-autocomplete>
        </div>
      </div>
    </p-card>

    <!-- ─── CARD 1: DADOS DO CLIENTE ──────────────────────────────────── -->
    <p-card class="reserva-card">
      <ng-template pTemplate="header">
        <div class="card-gradient-header">
          <i class="pi pi-user"></i>
          <span>Dados do Cliente</span>
        </div>
      </ng-template>

      <div class="grid">
        <!-- Cliente Estrangeiro -->
        <div class="col-12">
          <div class="checkbox-field">
            <p-checkbox
              inputId="clienteEstrangeiro"
              [(ngModel)]="clienteEstrangeiro"
              [binary]="true">
            </p-checkbox>
            <label for="clienteEstrangeiro" class="ml-2">Cliente Estrangeiro</label>
          </div>
        </div>

        <!-- CPF / CNPJ -->
        <div class="col-12 md:col-4" *ngIf="!clienteEstrangeiro">
          <app-input-cpf
            id="cpfCnpjCliente"
            label="CPF / CNPJ do Cliente"
            [(ngModel)]="cpfCnpjCliente"
            documentType="cpfCnpj"
            [required]="true"
            [showValidation]="tentouSalvar">
          </app-input-cpf>
        </div>

        <!-- Passaporte -->
        <div class="col-12 md:col-4" *ngIf="clienteEstrangeiro">
          <app-input-text
            id="passaporteCliente"
            label="Passaporte do Cliente"
            [(ngModel)]="passaporteCliente"
            [required]="true"
            [showValidation]="tentouSalvar"
            placeholder="Informe o passaporte">
          </app-input-text>
        </div>

        <!-- Nome do cliente -->
        <div class="col-12 md:col-8">
          <app-input-text
            id="nomeCliente"
            label="Nome Completo do Cliente"
            [(ngModel)]="nomeCliente"
            [required]="true"
            [showValidation]="tentouSalvar"
            placeholder="Digite o nome completo">
          </app-input-text>
        </div>

        <!-- Forma de Pagamento -->
        <div class="col-12 md:col-4">
          <app-autocomplete
            id="formaPagamento"
            label="Forma de Pagamento"
            [(ngModel)]="formaPagamento"
            [required]="false"
            [suggestions]="formaPagamentoSugestoes"
            field="label"
            placeholder="Selecione a forma de pagamento"
            (completeMethod)="filtrarFormaPagamento($event)"
            (onDropdownClick)="onDropdownClickFormaPagamento()">
          </app-autocomplete>
        </div>

        <!-- Data da Reserva -->
        <div class="col-12 md:col-3">
          <app-input-date
            id="dataReservaField"
            label="Data da Reserva"
            [(ngModel)]="dataReserva"
            [required]="true"
            [showValidation]="tentouSalvar"
            placeholder="dd/mm/aaaa">
          </app-input-date>
        </div>

        <!-- Data da Venda -->
        <div class="col-12 md:col-3">
          <app-input-date
            id="dataVendaField"
            label="Data da Venda"
            [(ngModel)]="dataVenda"
            [required]="false"
            [showValidation]="false"
            placeholder="dd/mm/aaaa">
          </app-input-date>
        </div>
      </div>
    </p-card>

    <!-- ─── CARD 2: IMOBILIÁRIA PRINCIPAL ─────────────────────────────── -->
    <p-card class="reserva-card">
      <ng-template pTemplate="header">
        <div class="card-gradient-header">
          <i class="pi pi-building"></i>
          <span>Imobiliária Principal</span>
        </div>
      </ng-template>

      <div class="grid">
        <!-- Imobiliária -->
        <div class="col-12 md:col-6">
          <app-autocomplete
            id="imobiliariaPrincipal"
            label="Imobiliária"
            [(ngModel)]="imobiliariaPrincipalSelecionada"
            [required]="true"
            [showValidation]="tentouSalvar"
            [suggestions]="imobiliariaPrincipalSugestoes"
            field="nomeFantasia"
            placeholder="Buscar imobiliária..."
            (completeMethod)="buscarImobiliarias($event, 'principal')"
            (onDropdownClick)="onDropdownClickImobiliariaPrincipal()"
            errorMessage="Imobiliária principal é obrigatória">
          </app-autocomplete>
        </div>

        <!-- Tipo de Contato -->
        <div class="col-12 md:col-3">
          <app-autocomplete
            id="tipoContatoPrincipal"
            label="Tipo de Contato"
            [(ngModel)]="tipoContatoPrincipalSelecionado"
            (ngModelChange)="onTipoContatoPrincipalAlterado()"
            [required]="false"
            [suggestions]="tipoContatoPrincipalSugestoes"
            field="label"
            placeholder="Tipo"
            (completeMethod)="filtrarTipoContatoPrincipal($event)"
            (onDropdownClick)="onDropdownClickTipoContatoPrincipal()">
          </app-autocomplete>
        </div>

        <!-- Contato -->
        <div class="col-12 md:col-3">
          <app-input-telefone
            *ngIf="isContatoTelefoneOuWhatsapp(tipoContatoPrincipalSelecionado?.value); else contatoPrincipalTexto"
            id="contatoPrincipal"
            label="Contato"
            [(ngModel)]="contatoPrincipal"
            [required]="false"
            [showValidation]="tentouSalvar">
          </app-input-telefone>
          <ng-template #contatoPrincipalTexto>
            <app-input-text
              id="contatoPrincipal"
              label="Contato"
              [(ngModel)]="contatoPrincipal"
              [type]="isContatoEmail(tipoContatoPrincipalSelecionado?.value) ? 'email' : 'text'"
              [required]="false"
              [placeholder]="isContatoEmail(tipoContatoPrincipalSelecionado?.value) ? 'email@exemplo.com' : 'E-mail, fone ou WhatsApp'">
            </app-input-text>
          </ng-template>
        </div>

        <!-- Profissionais -->
        <div class="col-12">
          <div class="profissionais-header">
            <span class="profissionais-label">
              <i class="pi pi-users"></i> Profissionais
            </span>
            <div class="flex gap-2 align-items-center">
              <button
                type="button"
                class="btn-adicionar-prof-icon"
                pTooltip="Adicionar profissional"
                tooltipPosition="left"
                (click)="adicionarProfissional('principal')">
                <i class="pi pi-plus"></i>
              </button>
              <button
                type="button"
                class="btn-novo-corretor-icon"
                pTooltip="Cadastro rápido de corretor"
                tooltipPosition="left"
                (click)="abrirCadastroRapido()">
                <i class="pi pi-user-plus"></i>
              </button>
            </div>
          </div>

          <div
            *ngFor="let prof of profissionaisPrincipal; let i = index"
            class="profissional-row">

            <!-- Tipo -->
            <div class="prof-field tipo">
              <app-autocomplete
                id="tipoProfissional_{{ i }}"
                label="Tipo"
                [(ngModel)]="prof.tipoProfissional"
                [required]="false"
                [suggestions]="tiposProfissionalSugestoes"
                field="label"
                placeholder="Tipo"
                (completeMethod)="filtrarTiposProfissional($event)"
                (onDropdownClick)="onDropdownClickTiposProfissional()">
              </app-autocomplete>
            </div>

            <!-- Corretor (busca por CPF) -->
            <div class="prof-field corretor">
              <div class="corretor-busca-row">
                <div class="corretor-cpf-field">
                  <app-input-cpf
                    id="cpfCorretorPrincipal_{{ i }}"
                    label="CPF do Corretor"
                    [(ngModel)]="prof.corretorCpfBusca"
                    [required]="false"
                    (ngModelChange)="onCpfCorretorAlterado(prof)"
                    (onBlur)="onCpfCorretorBlur(prof)">
                  </app-input-cpf>
                </div>
              </div>
              <div class="corretor-buscando" *ngIf="prof.corretorBuscando">
                <i class="pi pi-spin pi-spinner"></i>
                <span>Buscando corretor...</span>
              </div>
              <div class="corretor-nao-encontrado" *ngIf="!prof.corretorBuscando && prof.corretorNaoEncontrado">
                <i class="pi pi-exclamation-triangle"></i>
                <span>Corretor não encontrado para este CPF.</span>
                <button type="button" class="link-cadastro-rapido" (click)="abrirCadastroRapidoComCpf(prof.corretorCpfBusca)">
                  Usar cadastro rápido
                </button>
              </div>
              <div class="corretor-encontrado" *ngIf="prof.corretorCpfBusca && prof.corretor?.nome">
                <span class="corretor-encontrado-label">Corretor:</span>
                <span class="corretor-encontrado-valor">{{ prof.corretor?.nome }}</span>
              </div>
            </div>

            <!-- Remover -->
            <button
              type="button"
              class="btn-remover-prof-icon"
              pTooltip="Remover profissional"
              tooltipPosition="top"
              (click)="removerProfissional(i, 'principal')">
              <i class="pi pi-trash"></i>
            </button>
          </div>

          <div *ngIf="profissionaisPrincipal.length === 0" class="prof-vazio">
            Nenhum profissional adicionado. Clique em "Adicionar" para incluir corretores.
          </div>
        </div>
      </div>
    </p-card>

    <!-- ─── CARD 3: IMOBILIÁRIA SECUNDÁRIA ────────────────────────────── -->
    <p-card class="reserva-card">
      <ng-template pTemplate="header">
        <div
          class="card-gradient-header toggle"
          (click)="exibirSecundaria = !exibirSecundaria"
          style="cursor: pointer;">
          <i class="pi pi-building"></i>
          <span>Imobiliária Secundária</span>
          <span class="badge-opcional">Opcional</span>
          <i class="pi toggle-icon ml-auto"
             [ngClass]="exibirSecundaria ? 'pi-chevron-up' : 'pi-chevron-down'"></i>
        </div>
      </ng-template>

      <div *ngIf="!exibirSecundaria" class="secundaria-placeholder">
        <i class="pi pi-info-circle"></i>
        Clique no cabeçalho para informar uma imobiliária parceira
      </div>

      <div *ngIf="exibirSecundaria" class="grid">
        <!-- Imobiliária Secundária -->
        <div class="col-12 md:col-6">
          <app-autocomplete
            id="imobiliariaSecundaria"
            label="Imobiliária Parceira"
            [(ngModel)]="imobiliariaSecundariaSelecionada"
            [required]="false"
            [suggestions]="imobiliariaSecundariaSugestoes"
            field="nomeFantasia"
            placeholder="Buscar imobiliária parceira..."
            (completeMethod)="buscarImobiliarias($event, 'secundaria')"
            (onDropdownClick)="onDropdownClickImobiliariaSecundaria()">
          </app-autocomplete>
        </div>

        <div class="col-12 md:col-6" *ngIf="imobiliariaSecundariaSelecionada">
          <app-autocomplete
            id="tipoRelacionamentoSecundaria"
            label="Relacionamento com a Imobiliária Principal"
            [(ngModel)]="tipoRelacionamentoSecundariaSelecionado"
            [required]="true"
            [showValidation]="tentouSalvar"
            [suggestions]="tipoRelacionamentoSecundariaSugestoes"
            field="label"
            placeholder="Selecione o relacionamento"
            (completeMethod)="filtrarTipoRelacionamentoSecundaria($event)"
            (onDropdownClick)="onDropdownClickTipoRelacionamentoSecundaria()"
            errorMessage="Relacionamento é obrigatório quando houver imobiliária secundária">
          </app-autocomplete>
        </div>

        <div class="col-12" *ngIf="imobiliariaSecundariaSelecionada">
          <div class="flex justify-content-end">
            <app-custom-button
              label="Remover Imobiliária Secundária"
              icon="pi pi-trash"
              severity="danger"
              [outlined]="true"
              size="small"
              (onClick)="removerImobiliariaSecundaria()">
            </app-custom-button>
          </div>
        </div>

        <!-- Tipo de Contato Secundário -->
        <div class="col-12 md:col-3">
          <app-autocomplete
            id="tipoContatoSecundario"
            label="Tipo de Contato"
            [(ngModel)]="tipoContatoSecundarioSelecionado"
            (ngModelChange)="onTipoContatoSecundarioAlterado()"
            [required]="false"
            [suggestions]="tipoContatoSecundarioSugestoes"
            field="label"
            placeholder="Tipo"
            (completeMethod)="filtrarTipoContatoSecundario($event)"
            (onDropdownClick)="onDropdownClickTipoContatoSecundario()">
          </app-autocomplete>
        </div>

        <!-- Contato Secundário -->
        <div class="col-12 md:col-3">
          <app-input-telefone
            *ngIf="isContatoTelefoneOuWhatsapp(tipoContatoSecundarioSelecionado?.value); else contatoSecundarioTexto"
            id="contatoSecundario"
            label="Contato"
            [(ngModel)]="contatoSecundario"
            [required]="false"
            [showValidation]="tentouSalvar">
          </app-input-telefone>
          <ng-template #contatoSecundarioTexto>
            <app-input-text
              id="contatoSecundario"
              label="Contato"
              [(ngModel)]="contatoSecundario"
              [type]="isContatoEmail(tipoContatoSecundarioSelecionado?.value) ? 'email' : 'text'"
              [required]="false"
              [placeholder]="isContatoEmail(tipoContatoSecundarioSelecionado?.value) ? 'email@exemplo.com' : 'E-mail, fone ou WhatsApp'">
            </app-input-text>
          </ng-template>
        </div>

        <!-- Profissionais Secundária -->
        <div class="col-12" *ngIf="imobiliariaSecundariaSelecionada">
          <div class="profissionais-header">
            <span class="profissionais-label">
              <i class="pi pi-users"></i> Profissionais da Imobiliária Parceira
            </span>
            <div class="flex gap-2 align-items-center">
              <button
                type="button"
                class="btn-adicionar-prof-icon"
                pTooltip="Adicionar profissional"
                tooltipPosition="left"
                (click)="adicionarProfissional('secundaria')">
                <i class="pi pi-plus"></i>
              </button>
              <button
                type="button"
                class="btn-novo-corretor-icon"
                pTooltip="Cadastro rápido de corretor"
                tooltipPosition="left"
                (click)="abrirCadastroRapido()">
                <i class="pi pi-user-plus"></i>
              </button>
            </div>
          </div>

          <div
            *ngFor="let prof of profissionaisSecundaria; let i = index"
            class="profissional-row">
            <div class="prof-field tipo">
              <app-autocomplete
                id="tipoProfissionalSecundaria_{{ i }}"
                label="Tipo"
                [(ngModel)]="prof.tipoProfissional"
                [required]="false"
                [suggestions]="tiposProfissionalSugestoes"
                field="label"
                placeholder="Tipo"
                (completeMethod)="filtrarTiposProfissional($event)"
                (onDropdownClick)="onDropdownClickTiposProfissional()">
              </app-autocomplete>
            </div>
            <div class="prof-field corretor">
              <div class="corretor-busca-row">
                <div class="corretor-cpf-field">
                  <app-input-cpf
                    id="cpfCorretorSecundaria_{{ i }}"
                    label="CPF do Corretor"
                    [(ngModel)]="prof.corretorCpfBusca"
                    [required]="false"
                    (ngModelChange)="onCpfCorretorAlterado(prof)"
                    (onBlur)="onCpfCorretorBlur(prof)">
                  </app-input-cpf>
                </div>
              </div>
              <div class="corretor-buscando" *ngIf="prof.corretorBuscando">
                <i class="pi pi-spin pi-spinner"></i>
                <span>Buscando corretor...</span>
              </div>
              <div class="corretor-nao-encontrado" *ngIf="!prof.corretorBuscando && prof.corretorNaoEncontrado">
                <i class="pi pi-exclamation-triangle"></i>
                <span>Corretor não encontrado para este CPF.</span>
                <button type="button" class="link-cadastro-rapido" (click)="abrirCadastroRapidoComCpf(prof.corretorCpfBusca)">
                  Usar cadastro rápido
                </button>
              </div>
              <div class="corretor-encontrado" *ngIf="prof.corretorCpfBusca && prof.corretor?.nome">
                <span class="corretor-encontrado-label">Corretor:</span>
                <span class="corretor-encontrado-valor">{{ prof.corretor?.nome }}</span>
              </div>
            </div>
            <button
              type="button"
              class="btn-remover-prof-icon"
              pTooltip="Remover profissional"
              tooltipPosition="top"
              (click)="removerProfissional(i, 'secundaria')">
              <i class="pi pi-trash"></i>
            </button>
          </div>
        </div>
      </div>
    </p-card>

    <!-- ─── CARD 4: OBSERVAÇÕES ───────────────────────────────────────── -->
    <p-card class="reserva-card">
      <ng-template pTemplate="header">
        <div class="card-gradient-header">
          <i class="pi pi-file-edit"></i>
          <span>Observações</span>
        </div>
      </ng-template>

      <div class="grid">
        <div class="col-12">
          <app-input-textarea
            id="observacoes"
            label="Observações"
            [(ngModel)]="observacoes"
            [required]="false"
            placeholder="Informações adicionais sobre a reserva"
            [rows]="4">
          </app-input-textarea>
        </div>
      </div>
    </p-card>

    <!-- ─── BOTÕES DE AÇÃO ─────────────────────────────────────────────── -->
    <div class="form-actions">
      <app-custom-button
        label="Cancelar"
        icon="pi pi-times"
        severity="warning"
        actionType="cancel"
        (onClick)="voltar()">
      </app-custom-button>
      <app-custom-button
        label="Limpar"
        icon="pi pi-refresh"
        severity="info"
        [outlined]="true"
        actionType="clear"
        [disabled]="salvando || verificandoReserva"
        (onClick)="limparTela()">
      </app-custom-button>
      <app-custom-button
        label="Salvar Reserva"
        icon="pi pi-save"
        severity="success"
        [loading]="salvando"
        [disabled]="verificandoReserva"
        (onClick)="salvar()">
      </app-custom-button>
    </div>
  </div>

  <!-- ─── DIALOG: CADASTRO RÁPIDO DE CORRETOR ──────────────────────── -->
  <p-dialog
    header="Cadastro Rápido de Corretor"
    [(visible)]="displayCadastroRapido"
    [modal]="true"
    [style]="{'width': '480px'}"
    [breakpoints]="{'960px': '75vw', '640px': '95vw'}"
    [closable]="!salvandoCadastroRapido">

    <div class="grid" *ngIf="displayCadastroRapido">
      <div class="col-12">
        <app-input-cpf
          id="cadastroRapidoCpf"
          label="CPF do Corretor"
          [(ngModel)]="cadastroRapidoCpf"
          (ngModelChange)="onCadastroRapidoCpfChange()"
          [required]="true"
          [showValidation]="true">
        </app-input-cpf>
        <small *ngIf="validandoCpfCadastroRapido" class="p-text-secondary">
          Validando CPF...
        </small>
        <small
          *ngIf="mensagemValidacaoCpfCadastroRapido && !validandoCpfCadastroRapido"
          [class]="cpfCadastroRapidoJaCadastrado || cpfCadastroRapidoInvalido ? 'p-error' : 'p-text-success'">
          {{ mensagemValidacaoCpfCadastroRapido }}
        </small>
      </div>
      <div class="col-12">
        <app-input-text
          id="cadastroRapidoNome"
          label="Nome Completo"
          [(ngModel)]="cadastroRapidoNome"
          [required]="true"
          [disabled]="!camposCadastroRapidoHabilitados"
          [showValidation]="false"
          placeholder="Nome completo do corretor">
        </app-input-text>
      </div>
      <div class="col-12 md:col-6">
        <app-input-text
          id="cadastroRapidoEmail"
          label="E-mail"
          [(ngModel)]="cadastroRapidoEmail"
          [disabled]="!camposCadastroRapidoHabilitados"
          [required]="false"
          placeholder="email@exemplo.com">
        </app-input-text>
      </div>
      <div class="col-12 md:col-6">
        <app-input-telefone
          id="cadastroRapidoTelefone"
          label="Telefone"
          [(ngModel)]="cadastroRapidoTelefone"
          [disabled]="!camposCadastroRapidoHabilitados"
          [required]="false">
        </app-input-telefone>
      </div>
    </div>

    <ng-template pTemplate="footer">
      <div class="flex gap-2 justify-content-end">
        <app-custom-button
          label="Cancelar"
          icon="pi pi-times"
          severity="warning"
          [outlined]="true"
          [disabled]="salvandoCadastroRapido"
          (onClick)="displayCadastroRapido = false">
        </app-custom-button>
        <app-custom-button
          label="Cadastrar Corretor"
          icon="pi pi-save"
          severity="success"
          [loading]="salvandoCadastroRapido"
          [disabled]="
            salvandoCadastroRapido ||
            validandoCpfCadastroRapido ||
            !cadastroRapidoCpf ||
            !cadastroRapidoNome ||
            cpfCadastroRapidoJaCadastrado ||
            cpfCadastroRapidoInvalido ||
            !cpfCadastroRapidoPodeCadastrar
          "
          (onClick)="salvarCadastroRapido()">
        </app-custom-button>
      </div>
    </ng-template>
  </p-dialog>
</div>
