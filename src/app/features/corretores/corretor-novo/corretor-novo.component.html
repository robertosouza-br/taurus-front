<div class="form-container">
  <!-- Breadcrumb -->
  <app-breadcrumb [items]="breadcrumbItems"></app-breadcrumb>

  <!-- Page Header -->
  <app-page-header
    title="Novo Corretor"
    subtitle="Cadastre um novo corretor no sistema"
    icon="pi pi-briefcase">
  </app-page-header>

  <!-- Loading Salvamento -->
  <app-loading-spinner *ngIf="salvando" [overlay]="true" message="Salvando corretor..."></app-loading-spinner>

  <div class="corretor-form">
    <!-- Dados Pessoais -->
    <p-card header="Dados Pessoais">
      <div class="p-fluid">
        <br>
        <!-- CPF em PRIMEIRO LUGAR -->
        <div class="p-field">
          <app-input-cpf
            id="cpf"
            label="CPF"
            [(ngModel)]="cpf"
            (ngModelChange)="onCpfChange()"
            [required]="true"
            [showValidation]="tentouSalvar">
          </app-input-cpf>
          
          <!-- Loading da validação -->
          <div *ngIf="validandoCpf" class="cpf-validacao-loading">
            <i class="pi pi-spin pi-spinner"></i>
            <span>Validando CPF...</span>
          </div>
          
          <!-- Mensagem de validação -->
          <div *ngIf="mensagemValidacaoCpf && !validandoCpf" 
               class="cpf-validacao-mensagem"
               [ngClass]="{
                 'mensagem-invalido': cpfInvalido,
                 'mensagem-erro': cpfJaCadastrado && !cpfInvalido,
                 'mensagem-sucesso': !cpfJaCadastrado && !cpfInvalido
               }">
            <i [class]="cpfInvalido ? 'pi pi-times-circle' : (cpfJaCadastrado ? 'pi pi-exclamation-triangle' : 'pi pi-check-circle')"></i>
            <span>{{ mensagemValidacaoCpf }}</span>
          </div>
          
          <!-- Mensagem informativa se corretor já existe -->
          <small *ngIf="codcfoCorretorExistente && !validandoCpf" class="p-text-secondary" style="display: block; margin-top: 0.5rem;">
            <i class="pi pi-info-circle"></i> Redirecionando para edição...
          </small>
        </div>

        <!-- Demais campos DESABILITADOS até validar CPF -->
        <div class="p-field">
          <app-input-text
            id="nome"
            label="Nome Completo"
            [(ngModel)]="nome"
            [required]="true"
            [disabled]="!camposHabilitados || camposDoUsuarioLocal"
            [showValidation]="tentouSalvar">
          </app-input-text>
          <small *ngIf="camposDoUsuarioLocal" class="field-help" style="color: #64748b; display: block; margin-top: 0.25rem;">
            <i class="pi pi-info-circle"></i> Dados do usuário interno não podem ser alterados
          </small>
        </div>

        <div class="p-field">
          <app-input-emails
            id="email"
            label="E-mail(s)"
            [(ngModel)]="emails"
            [required]="true"
            [maxLength]="60"
            [disabled]="!camposHabilitados || camposDoUsuarioLocal"
            [showValidation]="tentouSalvar">
          </app-input-emails>
          <small *ngIf="camposDoUsuarioLocal" class="field-help" style="color: #64748b; display: block; margin-top: 0.25rem;">
            <i class="pi pi-info-circle"></i> Dados do usuário interno não podem ser alterados
          </small>
        </div>

        <div class="p-field">
          <app-input-text
            id="nomeGuerra"
            label="Nome de Guerra"
            [(ngModel)]="nomeGuerra"
            [required]="false"
            [disabled]="!camposHabilitados"
            [showValidation]="tentouSalvar">
          </app-input-text>
        </div>

        <div class="p-field">
          <app-input-telefone
            id="telefone"
            label="Telefone"
            [(ngModel)]="telefone"
            [required]="false"
            [disabled]="!camposHabilitados || camposDoUsuarioLocal"
            [showValidation]="tentouSalvar"
            placeholder="(00) 00000-0000">
          </app-input-telefone>
          <small *ngIf="camposDoUsuarioLocal" class="field-help" style="color: #64748b; display: block; margin-top: 0.25rem;">
            <i class="pi pi-info-circle"></i> Dados do usuário interno não podem ser alterados
          </small>
        </div>

        <div class="p-field">
          <app-input-text
            id="numeroCreci"
            label="Número do CRECI"
            [(ngModel)]="numeroCreci"
            [required]="false"
            [disabled]="!camposHabilitados"
            [showValidation]="tentouSalvar">
          </app-input-text>
        </div>

        <div class="p-field">
          <app-autocomplete
            id="cargo"
            label="Cargo"
            [(ngModel)]="cargoSelecionado"
            [suggestions]="cargosFiltrados"
            (completeMethod)="filtrarCargos($event)"
            (onDropdownClick)="mostrarTodosCargos()"
            field="label"
            [required]="true"
            [disabled]="true"
            [showValidation]="tentouSalvar"
            emptyMessage="Nenhum cargo encontrado"
            placeholder="Digite para buscar um cargo">
          </app-autocomplete>
        </div>
        <br>
      </div>
    </p-card>

    <!-- Dados Bancários -->
    <p-card header="Dados Bancários (Opcional)">
      <div class="p-fluid">
        <br>
        <div class="p-field">
          <app-autocomplete
            id="numeroBanco"
            label="Banco"
            [(ngModel)]="bancoSelecionado"
            [suggestions]="bancosFiltrados"
            (completeMethod)="filtrarBancos($event)"
            (onDropdownClick)="mostrarTodosBancos()"
            field="label"
            [required]="false"
            [disabled]="!camposHabilitados"
            [showValidation]="tentouSalvar"
            emptyMessage="Nenhum banco encontrado"
            placeholder="Digite o código ou nome do banco">
          </app-autocomplete>
        </div>

        <div class="p-field">
          <app-input-text
            id="numeroAgencia"
            label="Agência"
            [(ngModel)]="numeroAgencia"
            [required]="false"
            [disabled]="!camposHabilitados"
            [showValidation]="tentouSalvar">
          </app-input-text>
        </div>

        <div class="p-field">
          <app-input-text
            id="numeroContaCorrente"
            label="Conta Corrente"
            [(ngModel)]="numeroContaCorrente"
            [required]="false"
            [disabled]="!camposHabilitados"
            [showValidation]="tentouSalvar">
          </app-input-text>
        </div>

        <div class="p-field">
          <app-input-text
            id="tipoConta"
            label="Tipo de Conta"
            [(ngModel)]="tipoConta"
            [required]="false"
            [disabled]="!camposHabilitados"
            [showValidation]="tentouSalvar"
            placeholder="Ex: CORRENTE, POUPANÇA">
          </app-input-text>
        </div>
        <br>
      </div>
    </p-card>

    <!-- Dados PIX -->
    <p-card header="Dados PIX (Opcional)">
      <div class="p-fluid">
        <br>
        <div class="p-field">
          <app-autocomplete
            id="tipoChavePix"
            label="Tipo de Chave PIX"
            [(ngModel)]="tipoChavePixSelecionado"
            [suggestions]="tiposChavePixFiltrados"
            (completeMethod)="filtrarTiposChavePix($event)"
            (onDropdownClick)="mostrarTodosTiposChavePix()"
            field="label"
            [required]="false"
            [disabled]="!camposHabilitados"
            [showValidation]="tentouSalvar"
            emptyMessage="Nenhum tipo de chave encontrado"
            placeholder="Digite para buscar um tipo de chave">
          </app-autocomplete>
        </div>

        <div class="p-field">
          <app-input-text
            id="chavePix"
            label="Chave PIX"
            [(ngModel)]="chavePix"
            [required]="false"
            [disabled]="!camposHabilitados"
            [showValidation]="tentouSalvar">
          </app-input-text>
        </div>
        <br>
      </div>
    </p-card>

    <!-- Ações -->
    <div class="form-actions">
      <app-custom-button
        label="Cancelar"
        icon="pi pi-times"
        severity="warning"
        actionType="cancel"
        [requireConfirmation]="formularioAlterado"
        (onClick)="cancelar()"
        [disabled]="salvando">
      </app-custom-button>
      <app-custom-button
        label="Limpar"
        icon="pi pi-refresh"
        severity="info"
        actionType="clear"
        [outlined]="true"
        (onClick)="limparTela()"
        [disabled]="salvando || validandoCpf">
      </app-custom-button>
      <app-custom-button
        label="Criar Corretor"
        icon="pi pi-save"
        severity="success"
        actionType="save"
        (onClick)="salvarCorretor()"
        [disabled]="!camposHabilitados"
        [loading]="salvando">
      </app-custom-button>
    </div>
  </div>
</div>
