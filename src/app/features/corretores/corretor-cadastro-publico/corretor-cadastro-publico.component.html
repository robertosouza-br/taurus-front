<div class="cadastro-publico-container">
  <!-- Toast para mensagens -->
  <p-toast position="top-center" [baseZIndex]="99999"></p-toast>
  
  <div class="cadastro-card">
    <!-- Header -->
    <div class="cadastro-header">
      <img src="assets/images/logo_sm.png" alt="Taurus" class="logo">
      <h2>Cadastro de Corretor</h2>
      <p class="subtitle">Faça parte da nossa equipe de corretores</p>
    </div>

    <!-- Loading Salvamento -->
    <app-loading-spinner *ngIf="salvando" [overlay]="true" [message]="mensagemLoading"></app-loading-spinner>

    <!-- Formulário -->
    <div class="cadastro-form">
      
      <!-- Dados Pessoais -->
      <p-card>
        <ng-template pTemplate="header">
          <div class="card-header">
            <i class="pi pi-user"></i>
            <span>Dados Pessoais</span>
          </div>
        </ng-template>
        
        <!-- CPF em PRIMEIRO LUGAR -->
        <div class="cpf-field-container">
          <app-input-cpf
            id="cpf"
            label="CPF"
            [(ngModel)]="cpf"
            (ngModelChange)="onCpfChange()"
            [required]="true"
            [showValidation]="tentouSalvar">
          </app-input-cpf>
          
          <!-- Loading da validação -->
          <div *ngIf="validandoCpf" class="cpf-validacao-loading">
            <i class="pi pi-spin pi-spinner"></i>
            <span>Validando CPF...</span>
          </div>
          
          <!-- Mensagem de validação -->
          <div *ngIf="mensagemValidacaoCpf && !validandoCpf" 
               class="cpf-validacao-mensagem"
               [ngClass]="{
                 'mensagem-invalido': cpfInvalido,
                 'mensagem-erro': cpfJaCadastrado && !cpfInvalido,
                 'mensagem-sucesso': !cpfJaCadastrado && !cpfInvalido
               }">
            <i [class]="cpfInvalido ? 'pi pi-times-circle' : (cpfJaCadastrado ? 'pi pi-exclamation-triangle' : 'pi pi-check-circle')"></i>
            <span>{{ mensagemValidacaoCpf }}</span>
          </div>
          
          <!-- Botão Recuperar Senha -->
          <div *ngIf="cpfJaCadastrado" class="cpf-recuperar-senha">
            <app-custom-button
              label="Recuperar Senha"
              icon="pi pi-key"
              severity="warning"
              [outlined]="true"
              size="small"
              (onClick)="recuperarSenha()">
            </app-custom-button>
          </div>
        </div>

        <!-- Nome -->
        <div class="p-field">
          <app-input-text
            id="nome"
            label="Nome Completo"
            [(ngModel)]="nome"
            [required]="true"
            [disabled]="!camposHabilitados"
            [showValidation]="tentouSalvar">
          </app-input-text>
        </div>

        <!-- Email -->
        <div class="p-field">
          <app-input-emails
            id="email"
            label="E-mail(s)"
            [(ngModel)]="emails"
            [required]="true"
            [maxLength]="60"
            [disabled]="!camposHabilitados"
            [showValidation]="tentouSalvar">
          </app-input-emails>
        </div>

        <!-- Nome de Guerra -->
        <div class="p-field">
          <app-input-text
            id="nomeGuerra"
            label="Nome de Guerra"
            [(ngModel)]="nomeGuerra"
            [required]="false"
            [disabled]="!camposHabilitados"
            [showValidation]="tentouSalvar">
          </app-input-text>
        </div>

        <!-- Telefone -->
        <div class="p-field">
          <app-input-telefone
            id="telefone"
            label="Telefone"
            [(ngModel)]="telefone"
            [required]="false"
            [disabled]="!camposHabilitados"
            [showValidation]="tentouSalvar"
            placeholder="(00) 00000-0000">
          </app-input-telefone>
        </div>

        <!-- Número do CRECI -->
        <div class="p-field">
          <app-input-text
            id="numeroCreci"
            label="Número do CRECI"
            [(ngModel)]="numeroCreci"
            [required]="false"
            [disabled]="!camposHabilitados"
            [showValidation]="tentouSalvar">
          </app-input-text>
        </div>

        <!-- Cargo - SEMPRE FIXO EM CORRETOR E DESABILITADO -->
        <div class="p-field">
          <app-autocomplete
            id="cargo"
            label="Cargo"
            [(ngModel)]="cargoSelecionado"
            [suggestions]="cargosFiltrados"
            (completeMethod)="filtrarCargos($event)"
            (onDropdownClick)="mostrarTodosCargos()"
            field="label"
            [required]="true"
            [disabled]="true"
            [showValidation]="tentouSalvar"
            emptyMessage="Nenhum cargo encontrado"
            placeholder="Digite para buscar um cargo">
          </app-autocomplete>
        </div>
        <br>
      </p-card>

      <!-- Dados Bancários -->
      <p-panel 
        [toggleable]="true" 
        [collapsed]="true"
        collapseIcon="pi pi-chevron-up"
        expandIcon="pi pi-chevron-down">
        <ng-template pTemplate="header">
          <div class="panel-header">
            <i class="pi pi-building"></i>
            <span>Dados Bancários</span>
            <span class="optional-badge">(Opcional)</span>
          </div>
        </ng-template>
        
        <div class="p-fluid" style="padding: 1rem;">
          <div class="p-field">
            <app-autocomplete
              id="numeroBanco"
              label="Banco"
              [(ngModel)]="bancoSelecionado"
              [suggestions]="bancosFiltrados"
              (completeMethod)="filtrarBancos($event)"
              (onDropdownClick)="mostrarTodosBancos()"
              field="label"
              [required]="false"
              [disabled]="!camposHabilitados"
              [showValidation]="tentouSalvar"
              emptyMessage="Nenhum banco encontrado"
              placeholder="Digite o código ou nome do banco">
            </app-autocomplete>
          </div>

          <div class="p-field">
            <app-input-text
              id="numeroAgencia"
              label="Agência"
              [(ngModel)]="numeroAgencia"
              [required]="false"
              [disabled]="!camposHabilitados"
              [showValidation]="tentouSalvar">
            </app-input-text>
          </div>

          <div class="p-field">
            <app-input-text
              id="numeroContaCorrente"
              label="Conta Corrente"
              [(ngModel)]="numeroContaCorrente"
              [required]="false"
              [disabled]="!camposHabilitados"
              [showValidation]="tentouSalvar">
            </app-input-text>
          </div>

          <div class="p-field">
            <app-input-text
              id="tipoConta"
              label="Tipo de Conta"
              [(ngModel)]="tipoConta"
              [required]="false"
              [disabled]="!camposHabilitados"
              [showValidation]="tentouSalvar"
              placeholder="Ex: CORRENTE, POUPANÇA">
            </app-input-text>
          </div>
        </div>
      </p-panel>

      <!-- Dados PIX -->
      <p-panel 
        [toggleable]="true" 
        [collapsed]="true"
        collapseIcon="pi pi-chevron-up"
        expandIcon="pi pi-chevron-down">
        <ng-template pTemplate="header">
          <div class="panel-header">
            <i class="pi pi-qrcode"></i>
            <span>Dados PIX</span>
            <span class="optional-badge">(Opcional)</span>
          </div>
        </ng-template>
        
        <div class="p-fluid" style="padding: 1rem;">
          <div class="p-field">
            <app-autocomplete
              id="tipoChavePix"
              label="Tipo de Chave PIX"
              [(ngModel)]="tipoChavePixSelecionado"
              [suggestions]="tiposChavePixFiltrados"
              (completeMethod)="filtrarTiposChavePix($event)"
              (onDropdownClick)="mostrarTodosTiposChavePix()"
              field="label"
              [required]="false"
              [disabled]="!camposHabilitados"
              [showValidation]="tentouSalvar"
              emptyMessage="Nenhum tipo de chave encontrado"
              placeholder="Digite para buscar um tipo de chave">
            </app-autocomplete>
          </div>

          <div class="p-field">
            <app-input-text
              id="chavePix"
              label="Chave PIX"
              [(ngModel)]="chavePix"
              [required]="false"
              [disabled]="!camposHabilitados"
              [showValidation]="tentouSalvar">
            </app-input-text>
          </div>
        </div>
      </p-panel>

      <!-- Informativo -->
      <div class="info-message">
        <i class="pi pi-info-circle"></i>
        <div class="info-content">
          <div class="info-title">
            Importante
          </div>
          <p class="info-text">
            Após o cadastro, você receberá um e-mail com suas credenciais de acesso ao sistema.
          </p>
        </div>
      </div>

      <!-- Botões -->
      <div class="form-actions">
        <app-custom-button
          label="Voltar para Login"
          icon="pi pi-arrow-left"
          severity="secondary"
          [outlined]="true"
          [disabled]="salvando"
          (onClick)="voltarLogin()">
        </app-custom-button>
        
        <app-custom-button
          label="Cadastrar"
          icon="pi pi-check"
          severity="success"
          [loading]="salvando"
          [disabled]="!camposHabilitados || salvando"
          (onClick)="salvarCorretor()">
        </app-custom-button>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <div class="cadastro-footer">
    <p>&copy; 2026 CALTER Construtora - Todos os direitos reservados</p>
  </div>
</div>
