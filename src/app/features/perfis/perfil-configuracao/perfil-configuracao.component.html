<div class="configuracao-container">
  <!-- Breadcrumb -->
  <app-breadcrumb [items]="breadcrumbItems"></app-breadcrumb>

  <!-- Page Header -->
  <app-page-header
    [title]="perfil?.nome || 'Configuração de Perfil'"
    [subtitle]="perfil?.descricao || 'Defina permissões para cada funcionalidade'"
    icon="pi pi-shield"
    [actions]="headerActions">
    <ng-container pageHeaderExtra>
      <p-tag *ngIf="perfil" [value]="perfil.ativo ? 'Ativo' : 'Inativo'" [severity]="perfil.ativo ? 'success' : 'danger'"></p-tag>
    </ng-container>
  </app-page-header>

  <app-loading-spinner *ngIf="carregando" [overlay]="true" message="Carregando configurações..."></app-loading-spinner>

  <div *ngIf="!carregando && perfil" class="configuracao-content">
    <!-- Aviso para Perfis de Sistema -->
    <div *ngIf="isPerfilSistema" class="alert alert-sistema mb-3">
      <i class="pi pi-shield alert-icon"></i>
      <div class="alert-content">
        <strong>Perfil de Sistema</strong>
        <p *ngIf="isAdministrador">
          Este perfil possui acesso total ao sistema. Apenas a descrição pode ser alterada.
        </p>
        <p *ngIf="isCorretor">
          As permissões podem ser configuradas pelo administrador. O nome e status não podem ser alterados.
        </p>
      </div>
    </div>

    <!-- Dados do Perfil -->
    <p-card header="Dados do Perfil">
    <br>
      <div class="p-fluid">
        <div class="p-field">
          <app-input-text
            id="nome"
            label="Nome do Perfil"
            [(ngModel)]="perfil.nome"
            [required]="true"
            [readonly]="true"
            styleClass="readonly-field">
          </app-input-text>
          <small *ngIf="isPerfilSistema" class="field-info">
            <i class="pi pi-info-circle"></i>
            Perfis de sistema não podem ter o nome alterado
          </small>
        </div>

        <div class="p-field">
          <app-input-textarea
            id="descricao"
            label="Descrição"
            [(ngModel)]="perfil.descricao"
            [rows]="3"
            [required]="true"
            [showValidation]="tentouSalvar">
          </app-input-textarea>
        </div>

        <div class="p-field-checkbox">
          <p-checkbox 
            [(ngModel)]="perfil.ativo" 
            [binary]="true" 
            inputId="ativo"
            [disabled]="!podeAlterarStatus"
            label="Perfil Ativo">
          </p-checkbox>
          <small *ngIf="isPerfilSistema" class="field-info" style="margin-left: 2rem;">
            <i class="pi pi-info-circle"></i>
            Perfis de sistema não podem ser desativados
          </small>
        </div>
      </div>
    </p-card>

    <!-- Grid de funcionalidades -->
    <div class="funcionalidades-section">
      <h3 id="permissoes-section">Configurar Permissões por Funcionalidade</h3>
      <small class="p-error" *ngIf="tentouSalvar && !temPermissoesSelecionadas" style="display: block; margin-bottom: 1rem;">
        Selecione pelo menos uma permissão
      </small>

      <!-- Aviso para ADMINISTRADOR -->
      <div *ngIf="!podeAlterarPermissoes" class="alert alert-info mb-3">
        <i class="pi pi-info-circle alert-icon"></i>
        <div class="alert-content">
          <strong>Acesso Total</strong>
          <p>
            O perfil ADMINISTRADOR possui acesso total ao sistema e suas permissões não podem ser alteradas.
          </p>
        </div>
      </div>
      
      <div class="funcionalidades-grid" *ngIf="podeAlterarPermissoes">
        <p-card *ngFor="let func of funcionalidades" class="funcionalidade-card">
          <ng-template pTemplate="header">
            <div class="card-header">
              <div class="header-info">
                <h4>{{ func.nome }}</h4>
                <p-tag *ngIf="getNumeroPermissoes(func.codigo) > 0" 
                       [value]="getNumeroPermissoes(func.codigo) + ' selecionada(s)'"
                       severity="secondary"></p-tag>
              </div>
              <div class="header-actions">
                <i class="pi pi-check action-icon success-icon" 
                   pTooltip="Selecionar todas" 
                   tooltipPosition="top"
                   (click)="selecionarTodas(func.codigo, func.permissoesDisponiveis)"></i>
                <i class="pi pi-times action-icon danger-icon" 
                   pTooltip="Limpar seleção" 
                   tooltipPosition="top"
                   (click)="limparPermissoes(func.codigo)"></i>
              </div>
            </div>
          </ng-template>

          <p class="descricao">{{ func.descricao }}</p>

          <div class="permissoes-grid">
            <div *ngFor="let permissao of func.permissoesDisponiveis" class="permissao-item">
              <p-checkbox [binary]="true"
                          [ngModel]="isPermissaoSelecionada(func.codigo, permissao)"
                          (ngModelChange)="togglePermissao(func.codigo, permissao)"
                          [label]="permissao"
                          [inputId]="func.codigo + '-' + permissao"></p-checkbox>
            </div>
          </div>
        </p-card>
      </div>
    </div>

    <!-- Ações finais -->
    <div class="acoes-footer">
      <app-custom-button 
        label="Cancelar" 
        icon="pi pi-times"
        severity="warning"
        (onClick)="cancelar()">
      </app-custom-button>
      <app-custom-button 
        label="Limpar" 
        icon="pi pi-refresh"
        severity="info"
        [outlined]="true"
        (onClick)="limparTela()">
      </app-custom-button>
      <app-custom-button 
        label="Salvar" 
        icon="pi pi-save"
        severity="success"
        [loading]="salvando"
        (onClick)="salvarPerfil()">
      </app-custom-button>
    </div>
  </div>

  <div *ngIf="!carregando && !perfil" class="empty-message">
    <i class="pi pi-exclamation-triangle"></i>
    <h3>Perfil não encontrado</h3>
  </div>
</div>
