<div class="perfil-novo-container">
  <!-- Breadcrumb -->
  <app-breadcrumb [items]="breadcrumbItems"></app-breadcrumb>

  <!-- Page Header -->
  <app-page-header
    title="Novo Perfil"
    subtitle="Cadastre um perfil e defina suas permissões"
    icon="pi pi-plus-circle">
  </app-page-header>

  <p-progressSpinner *ngIf="carregando"></p-progressSpinner>

  <div class="perfil-form" *ngIf="!carregando">
    <!-- Dados Básicos -->
    <p-card header="Dados do Perfil">
      <div class="p-fluid">
        <br>
        <div class="p-field">
          <app-input-text
            id="nome"
            label="Nome do Perfil"
            [(ngModel)]="nome"
            [required]="true"
            [showValidation]="tentouSalvar">
          </app-input-text>
        </div>

        <div class="p-field">
          <app-input-textarea
            id="descricao"
            label="Descrição"
            [(ngModel)]="descricao"
            [rows]="3"
            [required]="true"
            [showValidation]="tentouSalvar">
          </app-input-textarea>
        </div>

        <div class="p-field-checkbox">
          <p-checkbox 
            [(ngModel)]="ativo" 
            [binary]="true" 
            inputId="ativo"
            label="Perfil Ativo">
          </p-checkbox>
        </div>
        <br>
      </div>
    </p-card>

    <!-- Permissões por Funcionalidade -->
    <h3 class="permissoes-titulo" id="permissoes-section">
      <i class="pi pi-shield"></i>
      Configurar Permissões
    </h3>
    <small class="p-error" *ngIf="tentouSalvar && !temPermissoesSelecionadas" style="display: block; margin-bottom: 1rem;">
      Selecione pelo menos uma permissão
    </small>

    <div class="funcionalidades-grid">
      <p-card *ngFor="let func of funcionalidades">
        <ng-template pTemplate="header">
          <div class="card-header-custom">
            <div class="header-info">
              <strong>{{ func.nome }}</strong>
              <p-tag 
                *ngIf="getNumeroPermissoes(func.codigo) > 0"
                [value]="getNumeroPermissoes(func.codigo) + ' selecionada(s)'"
                severity="secondary">
              </p-tag>
            </div>
            <div class="acoes-rapidas">
              <i class="pi pi-check action-icon success-icon" 
                 pTooltip="Selecionar Todas" 
                 tooltipPosition="top"
                 (click)="selecionarTodas(func.codigo, func.permissoesDisponiveis)"></i>
              <i class="pi pi-times action-icon danger-icon" 
                 pTooltip="Limpar Seleção" 
                 tooltipPosition="top"
                 (click)="limparPermissoes(func.codigo)"></i>
            </div>
          </div>
        </ng-template>

        <p class="descricao">{{ func.descricao }}</p>

        <div class="permissoes-grid">
          <div *ngFor="let perm of func.permissoesDisponiveis" class="permissao-item">
            <p-checkbox
              [binary]="true"
              [ngModel]="isPermissaoSelecionada(func.codigo, perm)"
              (ngModelChange)="togglePermissao(func.codigo, perm)"
              [label]="perm">
            </p-checkbox>
          </div>
        </div>
      </p-card>
    </div>

    <!-- Ações -->
    <div class="acoes-footer">
      <app-custom-button 
        label="Cancelar" 
        icon="pi pi-times"
        severity="warning"
        (onClick)="cancelar()"
        [disabled]="salvando">
      </app-custom-button>
      <app-custom-button 
        label="Criar Perfil" 
        icon="pi pi-save"
        severity="success"
        (onClick)="criarPerfil()"
        [loading]="salvando">
      </app-custom-button>
    </div>
  </div>
</div>
